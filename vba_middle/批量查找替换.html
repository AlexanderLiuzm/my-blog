<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>目标 | 一起来学VBA</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.5c65f556.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.b8d0ed68.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.16fc4d87.js" as="script"><link rel="preload" href="/my-blog/assets/js/3.40123aec.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.8e10b771.js"><link rel="prefetch" href="/my-blog/assets/js/11.dc4662bd.js"><link rel="prefetch" href="/my-blog/assets/js/12.66df6409.js"><link rel="prefetch" href="/my-blog/assets/js/13.2d325377.js"><link rel="prefetch" href="/my-blog/assets/js/14.f55b1da8.js"><link rel="prefetch" href="/my-blog/assets/js/15.6dbc8e41.js"><link rel="prefetch" href="/my-blog/assets/js/16.a0e2b506.js"><link rel="prefetch" href="/my-blog/assets/js/17.f25b4d50.js"><link rel="prefetch" href="/my-blog/assets/js/18.4b0b6022.js"><link rel="prefetch" href="/my-blog/assets/js/19.95508bb3.js"><link rel="prefetch" href="/my-blog/assets/js/20.1c5b9050.js"><link rel="prefetch" href="/my-blog/assets/js/21.ed2350eb.js"><link rel="prefetch" href="/my-blog/assets/js/22.32687073.js"><link rel="prefetch" href="/my-blog/assets/js/23.0ebed868.js"><link rel="prefetch" href="/my-blog/assets/js/24.4de088b5.js"><link rel="prefetch" href="/my-blog/assets/js/25.1e8b475b.js"><link rel="prefetch" href="/my-blog/assets/js/4.21d37fd2.js"><link rel="prefetch" href="/my-blog/assets/js/5.865d10fc.js"><link rel="prefetch" href="/my-blog/assets/js/6.ac699c54.js"><link rel="prefetch" href="/my-blog/assets/js/7.88812301.js"><link rel="prefetch" href="/my-blog/assets/js/8.535f8816.js"><link rel="prefetch" href="/my-blog/assets/js/9.475593e8.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.5c65f556.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">一起来学VBA</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/my-blog/vba_entry/" class="nav-link">Excel VBA</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="热门文章" class="dropdown-title"><span class="title">热门文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/vba_entry/ExcelVBA基本语法规则/" class="nav-link">VBA基本语法</a></li><li class="dropdown-item"><!----> <a href="/my-blog/vba_middle/利用ExcelVBA字典删除重复项/" class="nav-link">VBA字典的应用</a></li><li class="dropdown-item"><!----> <a href="/my-blog/vba_middle/二维表转一维表/" class="nav-link">二维表转一维表</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexanderLiuzm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link">主页</a></div><div class="nav-item"><a href="/my-blog/vba_entry/" class="nav-link">Excel VBA</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="热门文章" class="dropdown-title"><span class="title">热门文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/vba_entry/ExcelVBA基本语法规则/" class="nav-link">VBA基本语法</a></li><li class="dropdown-item"><!----> <a href="/my-blog/vba_middle/利用ExcelVBA字典删除重复项/" class="nav-link">VBA字典的应用</a></li><li class="dropdown-item"><!----> <a href="/my-blog/vba_middle/二维表转一维表/" class="nav-link">二维表转一维表</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/AlexanderLiuzm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/my-blog/vba_entry/" class="sidebar-link">初级</a></li><li><a href="/my-blog/vba_middle/" class="sidebar-link">中级</a></li><li><a href="/my-blog/vba_high/" class="sidebar-link">高级</a></li><li><a href="/my-blog/" class="sidebar-link">首页</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="目标"><a href="#目标" class="header-anchor">#</a> 目标</h2> <p>把单元格字符串中不完整的部分改成对应的完整部分
<img src="/my-blog/assets/img/batch_replace_1.7ad1ab38.jpg" alt="转换示意"></p> <p>原始的文档的C列中有很多是不完整的字符串</p> <p><img src="/my-blog/assets/img/batch_replace_original.662707f6.png" alt="原始"></p> <p>我们要通过对应的表格把不完整的字符串补充完整，有的后面加“版”，有的后面加“型”。</p> <p><img src="/my-blog/assets/img/batch_replace_dict.a1fe3244.png" alt="对应目录"></p> <p>最后得到类似这样的表格</p> <p><img src="/my-blog/assets/img/batch_replace_target.fbadaebf.png" alt="目标"></p> <h2 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h2> <h3 id="双层循环法"><a href="#双层循环法" class="header-anchor">#</a> 双层循环法</h3> <p>很多次的VBA课中都用到了双层循环法，这次当然也会第一个想到双层循环法，一个循环套在“数据”表格里，一个套在“条件”表格里，找到对应的字符串，并将其进行替换。</p> <h3 id="替换法"><a href="#替换法" class="header-anchor">#</a> 替换法</h3> <p>我们也可以直接利用替换的方法进行操作，直接按&quot;Ctrl+H&quot;，把&quot;标准&quot;替换成&quot;标准型&quot;，但是这样就会出现还有&quot;标准型型&quot;的单元格。之后我们可以在进行一次替换，把&quot;型型&quot;和&quot;版版&quot;替换成&quot;型&quot;和&quot;版&quot;。</p> <h2 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h2> <h3 id="双层循环法-2"><a href="#双层循环法-2" class="header-anchor">#</a> 双层循环法</h3> <h4 id="变量赋值"><a href="#变量赋值" class="header-anchor">#</a> 变量赋值</h4> <p>因为我们的循环语句当中经常要用到最大行号这个数值，所以我们先把两张工作表的最大行号都进行提取出来赋值给两个简短的变量<code>rw1</code>和<code>rw2</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>rw1 = ActiveSheet.UsedRange.Rows.Count
rw2 = Sheets(&quot;条件&quot;).UsedRange.Rows.Count
</code></pre></div><p>之后我们把两个数据表中的数据提取出来，赋值给数组，这样就不用一次一次定位工作表当中的单元格。我们把这些数据分别赋值给两个变量<code>arr1</code>和<code>arr2</code></p> <div class="language- extra-class"><pre class="language-text"><code>arr1 = ActiveSheet.Range(&quot;C1:C&quot; &amp; rw1).Value
arr2 = Sheets(&quot;条件&quot;).Range(&quot;A1:B&quot; &amp; rw2).Value
</code></pre></div><h4 id="循环语句"><a href="#循环语句" class="header-anchor">#</a> 循环语句</h4> <p>两张工作表中的数据都是从第<strong>2</strong>行开始的，所以我们建立两个循环都<strong>从2开始，分别到两个表格的最大行号为止</strong>。</p> <h4 id="判断语句"><a href="#判断语句" class="header-anchor">#</a> 判断语句</h4> <p>我们要找到两个表格当中的对应量，这里的话可以判断<strong>数据表格</strong>当中的<code>C</code>列字符串中是否包含<strong>条件表格</strong>中的<code>A</code>列中的不完整字符串，然后把它替换成<strong>条件表格</strong>中对应的<code>B</code>列字符串。这里会用到一个函数<code>InStr()</code> <img src="/my-blog/assets/img/batch_replace_2.40019dab.jpg" alt="Instr函数"></p> <div class="language- extra-class"><pre class="language-text"><code>For i = 2 To rw1
    For j = 2 To rw2
        If InStr(arr1(i, 1), arr2(j, 1)) Then
            arr1(i, 1) = Replace(arr1(i, 1), arr2(j, 1), arr2(j, 2))
        End If
    Next j
Next i
</code></pre></div><p>但是这个判断语句有个问题，即使字符串是完整的，也会被判断为包含<strong>条件表格</strong>当中<code>A</code>列的不完整字符串，这样就会出现诸如<em>尊享版版、标准型型</em>这种奇怪的东西。所以我们要再改进一下判断语句，让VBA判断如果<strong>数据表格</strong>中的<code>C</code>列字符串包含<strong>条件表格</strong>中的<code>B</code>列的字符串，即完整的字符串，就不进行替换操作。</p> <div class="language- extra-class"><pre class="language-text"><code>If InStr(arr1(i, 1), arr2(j, 1)) And Not (InStr(arr1(i, 1), arr2(j, 2))) Then
</code></pre></div><h4 id="替换"><a href="#替换" class="header-anchor">#</a> 替换</h4> <p>终于到了最后一步了，只要把对应的字符串进行替换就好了，这里要用到一个函数<code>Replace()</code> <img src="/my-blog/assets/img/batch_replace_3.77d72c1a.jpg" alt="Replace函数"></p> <div class="language- extra-class"><pre class="language-text"><code>ActiveSheet.Range(&quot;C1:C&quot; &amp; rw1).Value = arr1
</code></pre></div><h4 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h4> <div class="language- extra-class"><pre class="language-text"><code>Sub 双层循环法()

Dim rw1, rw2
Dim arr1, arr2
Dim i, j

rw1 = ActiveSheet.UsedRange.Rows.Count
rw2 = Sheets(&quot;条件&quot;).UsedRange.Rows.Count

arr1 = ActiveSheet.Range(&quot;C1:C&quot; &amp; rw1).Value
arr2 = Sheets(&quot;条件&quot;).Range(&quot;A1:B&quot; &amp; rw2).Value

For i = 2 To rw1
    For j = 2 To rw2
        If InStr(arr1(i, 1), arr2(j, 1)) And Not (InStr(arr1(i, 1), arr2(j, 2))) Then
            arr1(i, 1) = Replace(arr1(i, 1), arr2(j, 1), arr2(j, 2))
        End If
    Next j
Next i

ActiveSheet.Range(&quot;C1:C&quot; &amp; rw1).Value = arr1

MsgBox (&quot;替换完成&quot;)

End Sub
</code></pre></div><h3 id="查找替换法"><a href="#查找替换法" class="header-anchor">#</a> 查找替换法</h3> <h4 id="变量赋值-2"><a href="#变量赋值-2" class="header-anchor">#</a> 变量赋值</h4> <p>同上，我们可以精简代码，这次我们需要三个变量<code>rw1</code>，<code>rw2</code>和<code>arr</code></p> <div class="language- extra-class"><pre class="language-text"><code>rw1 = ActiveSheet.UsedRange.Rows.Count
rw2 = Sheets(&quot;条件&quot;).UsedRange.Rows.Count
arr = Sheets(&quot;条件&quot;).Range(&quot;A1:B&quot; &amp; rw2).Value
</code></pre></div><h4 id="替换-2"><a href="#替换-2" class="header-anchor">#</a> 替换</h4> <p>循环语句只有一层，非常简单，就和第一次的替换操作一起说吧。这里我们需要让<em>数据表</em>按照<em>条件表</em>的对应关系来进行替换，没法直接用简单的<em>替换操作</em>+<em>录制宏</em>来实现。这里我们还是要用到<code>Replace</code>，但是是<code>Replace</code>方法，语法有些许不同。
<img src="/my-blog/assets/img/batch_replace_4.af1651f4.jpg" alt="Replace方法"></p> <div class="language- extra-class"><pre class="language-text"><code>For i = 2 To rw2
    Range(&quot;C1:C&quot; &amp; rw1).Replace what:=arr(i, 1), Replacement:=arr(i, 2)
Next i
</code></pre></div><h4 id="二次替换"><a href="#二次替换" class="header-anchor">#</a> 二次替换</h4> <p>经过一次替换我们会的到很多带有两个&quot;版&quot;和两个&quot;型&quot;的单元格，这里我们再用一次<code>Replace</code>方法进行替换。</p> <div class="language- extra-class"><pre class="language-text"><code>Range(&quot;C1:C&quot; &amp; rw1).Replace what:=&quot;版版&quot;, Replacement:=&quot;版&quot;
Range(&quot;C1:C&quot; &amp; rw1).Replace what:=&quot;型型&quot;, Replacement:=&quot;型&quot;
</code></pre></div><h4 id="完整代码-2"><a href="#完整代码-2" class="header-anchor">#</a> 完整代码</h4> <div class="language- extra-class"><pre class="language-text"><code>Sub 查找替换法()

Dim rw1, rw2, arr

rw1 = ActiveSheet.UsedRange.Rows.Count
rw2 = Sheets(&quot;条件&quot;).UsedRange.Rows.Count
arr = Sheets(&quot;条件&quot;).Range(&quot;A1:B&quot; &amp; rw2).Value

For i = 2 To rw2
    Range(&quot;C1:C&quot; &amp; rw1).Replace what:=arr(i, 1), Replacement:=arr(i, 2)
Next i

Range(&quot;C1:C&quot; &amp; rw1).Replace what:=&quot;版版&quot;, Replacement:=&quot;版&quot;
Range(&quot;C1:C&quot; &amp; rw1).Replace what:=&quot;型型&quot;, Replacement:=&quot;型&quot;

MsgBox (&quot;替换完成&quot;)

End Sub
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/my-blog/assets/js/app.b8d0ed68.js" defer></script><script src="/my-blog/assets/js/2.16fc4d87.js" defer></script><script src="/my-blog/assets/js/3.40123aec.js" defer></script>
  </body>
</html>
